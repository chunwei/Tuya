/*!
 * Sketch (2015-02-23, 15:59)
 *
 * Copyright (C) 2011-2015 Hakim El Hattab, http://hakim.se
 */window.sketch={},sketch.IO=function(){function a(a,b){return a||0==a?a:b}var b="/php/sketch.php",c="/php/sketch.php",d="/php/gallery.php",e="x",f=null;return{initialize:function(){f=sketch.Main.linesToJSON()},hasUnsavedChanges:function(){return sketch.Main.linesToJSON()!==f},saveSketch:function(){var a=sketch.Main.linesToJSON();this.hasUnsavedChanges()?a.length>255?(sketch.LoadingOverlay.show("Saving sketch",100),$.post(b,"save="+a,function(b){sketch.LoadingOverlay.hide(),b.match(/error/gi)?alert("Uh-oh, the server replied with a no-no :( Wait a minute and try again."):(f=a,sketch.URL.writeID(b),sketch.Facebook.isConnected()&&FB.api("/me/sketchtoy:draw","post",{sketch:sketch.Main.getSketchShareURL()},function(a){!a||a.error}),sketch.ShareOverlay.show(),sketch.Related.update())})):alert("Please draw more before saving."):sketch.ShareOverlay.show()},loadSketch:function(a,b){$.get(c,{load:a},function(a,c){if(a.match(/error/gi))alert("There was an error loading your sketch."),b("error",{});else{f=a;var c="success";try{var d=sketch.IO.parseSketch($.parseJSON(a))}catch(e){c="error",alert("Uh-oh, an error occured while trying to load this sketch.")}b(c,d)}})},parseSketch:function(b){for(var c=a(b.p,b.perspective),d=a(b.a,b.amplitude),f=a(b.l,b.lines),g=0;g<f.length;g++){f[g].color=a(f[g].c,"#000000"),f[g].thickness=a(f[g].t,f[g].thickness),f[g].perspective=a(f[g].p,f[g].perspective),f[g].dashed=!!a(f[g].d,f[g].dashed),f[g].eraser=!!a(f[g].e,f[g].eraser),f[g].points=a(a(f[g].l,f[g].points),[]);for(var h=f[g].points,i=0;i<h.length;i++){var j={position:{x:0,y:0},normal:{x:0,y:0}};"string"==typeof h[i]?(j.position.x=parseFloat(h[i].slice(0,h[i].indexOf(e))),j.position.y=parseFloat(h[i].slice(h[i].indexOf(e)+1))):(j.position.x=h[i].x,j.position.y=h[i].y),j.normal.x=j.position.x,j.normal.y=j.position.y,h[i]=j}}for(var g=0;g<f.length;g++){var h=f[g].points;0===h.length&&(f.splice(g,1),g--)}return{perspective:c,amplitude:d,lines:f}},loadGalleryItems:function(a,b,c,e){$.get(d,{load:a,start:b,end:c},function(a,b){if(a.match(/error/gi))alert("There was an error loading the sketches.");else{var b="success",c=1,d=[];try{a=$.parseJSON(a),c=a.totalRows;for(var f=0;f<a.sketches.length;f++){var g=g.IO.parseSketch(a.sketches[f].value);g.id=a.sketches[f].id,g.date=a.sketches[f].date,g.views=a.sketches[f].views,d.push(g)}}catch(h){b="error",alert("Uh-oh, an error occured while trying to load the sketches.")}e(b,d,c)}})}}}(),sketch.URL=function(){function a(){return!(!window.history||!history.pushState)}var b="";return{readID:function(){var a=window.location.pathname.split("/")[1];return b.length?b:a.length?a:window.location.hash.slice(1)},writeID:function(c){b=c,a()&&history.pushState({},"Sketch Toy: "+c,"/"+c);var d=$('meta[property="og:url"]');0===d.length&&(d=$('<meta property="og:url" />'),d.appendTo($("head"))),d.attr("content",sketch.Main.getSketchShareURL())}}}(),sketch.Util=function(){return{hexToRGB:function(a){return"string"==typeof a?(a=a.split("#").join(""),{r:parseInt(a.slice(0,2),16),g:parseInt(a.slice(2,4),16),b:parseInt(a.slice(4,6),16)}):{r:0,g:0,b:0}},wrapNumber:function(a,b){return a>b?-b+a%b:-b>a?b+a%b:a},distanceBetween:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},supportsLocalStorage:function(){try{return localStorage.setItem("t","t"),localStorage.removeItem("t"),!0}catch(a){return!1}},isTouchDevice:function(){return!!navigator.userAgent.match(/ipod|ipad|iphone|android/gi)}}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),sketch.Locale=function(){function a(){c(),d(),i.find("li").on("click",function(a){var b=$(a.target).attr("data-language");"string"==typeof b&&g[b]&&sketch.Locale.change(b)}),i.on("mouseenter",function(){i.find(".list").show()}),i.on("mouseleave",function(){i.find(".list").hide()})}function b(){sketch.Util.supportsLocalStorage()&&localStorage.setItem(e,h)}function c(){if(sketch.Util.supportsLocalStorage()&&(h=localStorage.getItem(e),SketchConfig.autodetectLanguage&&!h)){var a=window.navigator.userLanguage||window.navigator.language;a&&(a=a.slice(0,2).toLowerCase(),g[a]&&(sketch.Main.trackEvent("Locale","Change Automatically",a,null,!0),h=a,b()))}g[h]||(h=f)}function d(){var a=$(".toolbar");a.find(".new-button").text(sketch.Locale.string("new")),a.find(".save-button").text(sketch.Locale.string("save")),a.find(".undo-button").text(sketch.Locale.string("undo")),a.find(".eraser-toggle").text(sketch.Locale.string("erase")),a.find(".facebook-share .label").text(sketch.Locale.string("share")),a.find(".facebook-send .label").text(sketch.Locale.string("send")),a.find(".tweet-button .label").text(sketch.Locale.string("tweet")),a.find(".size-dropdown .dropdown-title .label").text(sketch.Locale.string("size")+":"),a.find(".color-dropdown .dropdown-title .label").text(sketch.Locale.string("color")),a.find(".color-dropdown .dropdown-title .label").text(sketch.Locale.string("color")),a.find(".vibration-dropdown .dropdown-title .label").text(sketch.Locale.string("vibration")+":");var b=$(".share-overlay");b.find(".url .label").text(sketch.Locale.string("share-link")+":"),b.find(".share-facebook .label").text(sketch.Locale.string("share-fb")),b.find(".share-facebook-message .label").text(sketch.Locale.string("share-fb-message")),b.find(".share-facebook-photo .label").text(sketch.Locale.string("share-upload")),b.find(".share-email .label").text(sketch.Locale.string("share-email")),b.find(".share-twitter .label").text(sketch.Locale.string("share-tweet")),b.find(".share-download .label").text(sketch.Locale.string("share-download"));var c=$("footer");c.find(".links .terms").text(sketch.Locale.string("terms")),c.find(".links .privacy").text(sketch.Locale.string("privacy")),i.find(".button .label").text(sketch.Locale.string("language")+":"),i.find(".button .value").text(i.find(".list li[data-language="+h+"]").text()),i.removeClass("loading");var d=a.get(0),e=a.css("display");d.style.display="none",d.offsetHeight,d.style.display=e}var e="sketch-toy-language",f="en",g={en:{"new":"New",save:"Save",undo:"Undo",erase:"Erase",size:"Size",vibration:"Vibration",color:"Color",show:"Show",hide:"Hide",remove:"Remove",share:"Share",send:"Send",tweet:"Tweet","share-link":"Link","share-fb":"Share","share-fb-message":"Send Message","share-tweet":"Tweet","share-email":"Email","share-upload":"Upload Image","share-download":"Download Image","featured-sketches":"Featured Sketches",comments:"Comments","connect-fb":"Connect With Facebook",language:"Language",terms:"Terms of Service",privacy:"Privacy","promotion-title":"Sketch Toy","promotion-body":"Sketch using animated lines and share replays with friends!","sketch-fb":"An animated sketch! Click to replay.","sketch-tweet":"Check out this drawing!","alert-unsaved-statement":"The current drawing will be lost","alert-unsaved-confirmation":"The current drawing will be lost, do you want to continue?"},pt:{"new":"Novo",save:"Salvar",undo:"Apagar",erase:"Desfazer",size:"Tamanho",vibration:"Vibração",color:"Cor",show:"Mostrar",hide:"Esconder",remove:"Remover",share:"Compartilhar",send:"Enviar",tweet:"Tuitar","share-link":"Link","share-fb":"Compartilhar","share-fb-message":"Enviar Mensagem","share-tweet":"Tuitar","share-email":"Enviar Email","share-upload":"Upload de Imagem","share-download":"Download da Imagem","featured-sketches":"Desenhos em destaque",comments:"Comentários","connect-fb":"Conectar com Facebook",language:"Língua",terms:"Termos de Serviço",privacy:"Privacidade","promotion-title":"Sketch Toy","promotion-body":"Faça desenhos e compartilhe o replay com amigos","sketch-fb":"Um desenho animado! Clique para assistir o replay.","sketch-tweet":"Olhe esse desenho!","alert-unsaved-statement":"O desenho atual será perdido.","alert-unsaved-confirmation":"O desenho atual será perdido, quer continuar?"},es:{"new":"Nuevo",save:"Guardar",undo:"Deshacer",erase:"Borrar",size:"Tamaño",vibration:"Vibración",color:"Color",show:"Mostrar",hide:"Ocultar",remove:"Eliminar",share:"Compartir",send:"Enviar",tweet:"Tweet","share-link":"Enlace","share-fb":"Compartir","share-fb-message":"Enviar mensajee","share-tweet":"Tweet","share-email":"Email","share-upload":"Subir imagene","share-download":"Descargar Imagene","featured-sketches":"Bocetos destacados",comments:"Comentarios","connect-fb":"Conéctate con Facebook",language:"Idioma",terms:"Términos de Servicio",privacy:"Privacidad","promotion-title":"Sketch Toy","promotion-body":"Dibuja bocetos y compartir repeticiones con amigos","sketch-fb":"Un dibujo animado! Haz clic aquí para reproducir.","sketch-tweet":"Echa un vistazo a este dibujo!","alert-unsaved-statement":"Se perderá el dibujo actual","alert-unsaved-confirmation":"Se perderá el dibujo actual, ¿desea continuar?"},tr:{"new":"Yeni",save:"Kaydet",undo:"Geri Al",erase:"Sil",size:"Boyut",vibration:"Titreşim",color:"Renk",show:"Göster",hide:"Gizle",remove:"Kaldır",share:"Paylaş",send:"Mesaj",tweet:"Tweet At","share-link":"Bağlantı","share-fb":"Paylaş","share-fb-message":"Mesaj Gönder","share-tweet":"Tweet At","share-email":"E-posta","share-upload":"Resim Yükle","share-download":"Resmi İndir","featured-sketches":"Öne çıkan çizimler",comments:"Yorumlar","connect-fb":"Facebook ile Bağlan",language:"Dil",terms:"Hizmet Şartları",privacy:"Gizlilik","promotion-title":"Sketch Toy","promotion-body":"Çizim yapın ve arkadaşlarınızla paylaşın.","sketch-fb":"Hareketli bir çizim! İzlemek için tıklayın.","sketch-tweet":"Şu çizime bakın!","alert-unsaved-statement":"Geçerli çizim kaybolacak.","alert-unsaved-confirmation":"Geçerli çizim kaybolacak. Devam etmek istiyor musunuz?"}},h=f,i=$(".select-language");return{initialize:a,string:function(a){var b=g[h]||b[f],c=b[a];return"undefined"==typeof c&&(c=g[f][a]),"undefined"==typeof c&&(c=""),c},change:function(a){g[a]&&(sketch.Main.trackEvent("Locale","Change",a),h=a,b(),window.location.reload())}}}(),sketch.Social=function(){function a(){e||sketch.Util.isTouchDevice()||(e=!0,b(),c())}function b(){$.ajax({url:"//platform.twitter.com/widgets.js",type:"GET",dataType:"script"})}function c(){}function d(a,b,c,d){var e="https://twitter.com/intent/tweet?url="+encodeURIComponent(a)+"&text="+encodeURIComponent(b)+"&related=sketchtoy";d&&(e+="&via="+d),c&&(e+="&hashtags="+c);var f=550,g=420,h=Math.round(screen.width/2-f/2);y=0,screen.height>g&&(y=Math.round(screen.height/2-g/2)),window.open(e,"twitter_share","height="+g+", width="+f+", left="+h+", top="+y+", toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, directories=no, status=no")}var e=!1;return{initialize:a,tweet:d}}(),sketch.Related=function(){function a(){f=$(".related"),g=$(".related-gallery"),h=$(".related-comments"),i||sketch.Util.isTouchDevice()||(i=!0,"/"!==window.location.pathname?(d(),b()):b("horizontal"))}function b(a){g.length&&(g.addClass(a),$.ajax({url:"http://sketch-toy.tumblr.com/api/read/json?callback=?",dataType:"script",context:this,success:function(){"object"==typeof tumblr_api_read&&tumblr_api_read.posts.length&&c(tumblr_api_read.posts)}}))}function c(a){if(a&&g.length){$("<h3>").text(sketch.Locale.string("featured-sketches")+":").appendTo(g);for(var b="/"===window.location.pathname?6:4,c=0,d=Math.min(a.length,b);d>c;c++){var e=a[c];$(['<a href="'+e["photo-link-url"]+'">','<img src="'+e["photo-url-250"]+'">',"</a>"].join("")).appendTo(g)}}}function d(){h.length&&(h.empty().append("<h3>"+sketch.Locale.string("comments")+":</h3>",'<div class="fb-comments" data-href="'+sketch.Main.getSketchShareURL()+'" data-width="500" data-num-posts="3"></div>'),h.addClass("visible"),FB.XFBML.parse(h.get(0)))}function e(){i&&"/"!==window.location.pathname&&d()}var f,g,h,i=!1;return{initialize:a,update:e}}(),sketch.Dropdown={create:function(a){function b(){n.addClass("open"),o.addClass("open"),$(document).on("mousedown",m),d()}function c(){n.removeClass("open"),o.removeClass("open"),$(document).off("mousedown",m)}function d(){var a=n.outerWidth(),b=o.outerWidth();o.css("margin-left",-(b-a)/2)}function e(a){q=a,n.find(".value").text(a),o.find("button").removeClass("selected"),o.find('button[data-value="'+q+'"]').addClass("selected")}function f(){return q}function g(a){a.preventDefault()}function h(a){a.preventDefault(),n.hasClass("open")?c():b()}function i(a){a.preventDefault()}function j(a){a.preventDefault();var b=$(a.currentTarget);b.length&&(e(b.attr("data-value")),c(),"function"==typeof this.onChanged&&this.onChanged(q))}function k(){o.hasClass("auto-width")&&o.width(n.outerWidth()-1),b()}function l(){c()}function m(b){for(var d=b.target,e=!0;d&&d.getAttribute;){if(d&&d==a.get(0)){e=!1;break}d=d.parentNode}e&&c()}var n=a.find(".dropdown-title"),o=a.find(".dropdown-list"),p=o.find(".dropdown-item"),q=null;a.on("mouseover",$.proxy(k,this)),a.on("mouseout",$.proxy(l,this)),n.on("click",$.proxy(g,this)),n.on("touchstart",$.proxy(h,this)),n.on("mousedown",$.proxy(i,this)),p.on("click touchstart",$.proxy(j,this)),this.setValue=e,this.getValue=f}},sketch.Facebook=function(){function a(){r=$(".facebook-send"),s=$(".facebook-share"),$facebookInvite=$(".facebook-invite"),t=$(".facebook-connect"),$facebookContents=$(".facebook-connect .contents"),r.on("click",l),s.on("click",k),$facebookInvite.on("click",m),t.on("click",n),FB.getLoginStatus(function(a){a&&"connected"===a.status?d(null,!0):f(!1)})}function b(a,b){a=a||function(){},FB.getLoginStatus(function(c){"connected"!==c.status||b?FB.login(function(b){b.authResponse?a.call(null,!0):a.call(null,!1)},b):a.call(null,!0)})}function c(a,b){b=b||function(){},FB.api("/me/permissions",function(c){if(c&&c.data&&c.data.length)for(var d=0;d<c.data.length;d++){var e=c.data[d];if(e.permission===a&&"granted"===e.status)return void b.call(null,!0)}b.call(null,!1)})}function d(a,b){a=a||function(){},c("publish_actions",function(c){c?(f(!0),a.call(null,!0)):b?(f(!1),a.call(null,!1)):FB.login(function(b){b.authResponse?d(null,!0):(f(!1),a.call(null,!1))},{scope:"publish_actions"})})}function e(a){p&&p.id&&FB.api(p.id+"/permissions?permission=publish_actions","delete",{},function(b){!b||b.error?a.call(null,!1):a.call(null,!0)})}function f(a){u=a,$facebookContents.empty(),u?FB.api("/me",{fields:"id,name,first_name,picture"},function(a){if(a){p=a;var b=$('<div class="title">').text("Hello "+a.first_name+"!").appendTo($facebookContents);a.picture&&a.picture.data&&$('<img class="avatar">').attr({src:a.picture.data.url,height:26}).prependTo(b);var c=$('<div class="dropdown">').appendTo($facebookContents);$("<p>").text("Sketches you save are automatically published to your Facebook stream.").appendTo(c),$('<a href="#">').text("Disconnect?").appendTo(c).on("click",o)}t.removeClass("loading").addClass("connected")}):t.removeClass("loading").removeClass("connected")}function g(a,b,c){FB.ui({method:"send",name:b,link:a,description:c})}function h(a,b,c){FB.ui({method:"feed",name:b,link:a,description:c})}function i(){function a(){q&&q.abort();var a=new FormData;a.append("file",f),a.append("access_token",FB.getAccessToken()),a.append("message","Replay: "+sketch.Main.getSketchShareURL()),q=$.ajax({url:"https://graph.facebook.com/me/photos",data:a,type:"POST",cache:!1,contentType:!1,processData:!1,timeout:3e4,statusCode:{400:function(){e()},401:function(){e()},403:function(){e()},500:function(){e()}},complete:function(a,b){var c;try{c=$.parseJSON(a.responseText)}catch(f){e(b)}c&&0===c.success?e():"OK"===a.statusText&&c&&c.id?d():e()}})}function d(){sketch.LoadingOverlay.hideSuccess("Photo uploaded!"),sketch.Main.trackEvent("Facebook","Photo Upload Success")}function e(){sketch.LoadingOverlay.hideError("Failed to upload photo"),sketch.Main.trackEvent("Facebook","Photo Upload Error")}sketch.LoadingOverlay.show("Uploading photo...");var f=sketch.Main.getSketchAsBlob();f&&c("publish_actions",function(c){c&&FB.getAccessToken()?a():b(function(b){b?a():(sketch.LoadingOverlay.hide(),sketch.Main.trackEvent("Facebook","Photo Upload Cancel"))},{scope:"publish_actions"})})}function j(){return u}function k(a){sketch.URL.readID()?sketch.Facebook.share(sketch.Main.getSketchShareURL(),sketch.Locale.string("promotion-title"),sketch.Locale.string("promotion-body")):sketch.Facebook.share(window.location.protocol+"//"+window.location.host+"/",sketch.Locale.string("promotion-title"),sketch.Locale.string("promotion-body")),sketch.Main.trackEvent("Toolbar","Facebook Share"),a.preventDefault()}function l(a){sketch.URL.readID()?sketch.Facebook.send(sketch.Main.getSketchShareURL(),sketch.Locale.string("sketch-fb"),sketch.Locale.string("promotion-body")):sketch.Facebook.send(window.location.protocol+"//"+window.location.host+"/",sketch.Locale.string("promotion-title"),sketch.Locale.string("promotion-body")),sketch.Main.trackEvent("Toolbar","Facebook Send"),a.preventDefault()}function m(a){FB.ui({method:"apprequests",message:"Sketch with me",filters:[]},function(a){return a&&a.to?void sketch.Main.trackEvent("Header","Facebook Invite Sent"):(sketch.Main.trackEvent("Header","Facebook Invite Cancel"),!1)}),sketch.Main.trackEvent("Header","Facebook Invite"),a.preventDefault()}function n(a){t.hasClass("loading")||t.hasClass("connected")||(j()||sketch.Facebook.login(function(a){a?d(null,!0):f(!1)},{scope:"publish_actions"}),sketch.Main.trackEvent("Header","Facebook Connect")),a.preventDefault()}function o(a){e(function(a){a&&f(!1)}),sketch.Main.trackEvent("Header","Facebook Disconnect"),a.preventDefault()}var p,q,r,s,t,u=!1;return{initialize:a,login:b,send:g,share:h,upload:i,connect:d,isConnected:j}}(),sketch.ShareOverlay=function(){function a(){m.val(sketch.Main.getSketchShareURL());var a=encodeURIComponent("An animated sketch"),b=encodeURIComponent("Check out this sketch: "+sketch.Main.getSketchShareURL());n.attr("href","mailto:?body="+b+"&subject="+a);var c=l.find(".share-download");c.length&&"undefined"!=typeof c.get(0).download&&l.find(".share-download").off().attr({href:sketch.Main.getSketchAsImage(),download:"sketch-"+sketch.URL.readID()+".png",target:""})}function b(a){a.preventDefault(),sketch.ShareOverlay.hide()}function c(a){a.target===l.get(0)&&(a.preventDefault(),sketch.ShareOverlay.hide())}function d(a){a.preventDefault(),m.select()}function e(a){a.preventDefault(),sketch.Facebook.share(sketch.Main.getSketchShareURL(),p),sketch.Main.trackEvent("Share","Facebook")}function f(a){a.preventDefault(),sketch.Facebook.send(sketch.Main.getSketchShareURL(),p),sketch.Main.trackEvent("Share","Facebook Message")}function g(a){a.preventDefault(),sketch.Facebook.upload(),sketch.Main.trackEvent("Share","Facebook Photo")}function h(a){a.preventDefault(),sketch.Social.tweet(sketch.Main.getSketchShareURL(),o,"sketchtoy","sketchtoy"),sketch.Main.trackEvent("Share","Twitter")}function i(){sketch.Main.trackEvent("Share","Email")}function j(a){a.preventDefault(),sketch.Main.saveSketchAsImage(),sketch.Main.trackEvent("Share","Download")}function k(a){27===a.keyCode&&(a.preventDefault(),sketch.ShareOverlay.hide())}var l=$(".share-overlay"),m=l.find(".url input"),n=l.find(".share-email"),o="",p="";return l.find(".close").on("click",b),l.find(".share-facebook").on("click",e),l.find(".share-facebook-message").on("click",f),l.find(".share-facebook-photo").on("click",g),l.find(".share-twitter").on("click",h),l.find(".share-email").on("click",i),l.find(".share-download").on("click",j),l.on("click",c),m.on("click",d),{show:function(){l.toggleClass("empty",sketch.Main.isEmpty()),l.show(),sketch.Main.isEmpty()?(p=sketch.Locale.string("promotion-title"),o=sketch.Locale.string("promotion-body")):(p=sketch.Locale.string("sketch-fb"),o=sketch.Locale.string("sketch-tweet")),a(),m.select(),$(document).on("keydown",k)},hide:function(){l.hide(),$(document).off("keydown",k)}}}(),sketch.LoadingOverlay=function(){{var a=$(".loading-overlay");a.find(".status")}return loadingMessage=a.find(".message"),timeout=-1,{show:function(b,c){clearTimeout(timeout),"number"==typeof c?timeout=setTimeout(function(){sketch.LoadingOverlay.show(b)},c):(a.addClass("visible"),a.removeClass("success-state error-state").addClass("loading-state"),loadingMessage.text(b||""))},hide:function(){clearTimeout(timeout),a.removeClass("visible")},hideSuccess:function(b){a.removeClass("loading-state error-state").addClass("success-state"),loadingMessage.text(b||""),clearTimeout(timeout),timeout=setTimeout(sketch.LoadingOverlay.hide,2e3)},hideError:function(b){a.removeClass("success-state loading-state").addClass("error-state"),loadingMessage.text(b||""),clearTimeout(timeout),timeout=setTimeout(sketch.LoadingOverlay.hide,3e3)}}}(),sketch.Main=function(){function a(a){$(document.body).addClass("loading"),sketch.IO.loadSketch(a,function(a,b){$(document.body).removeClass("loading"),"success"===a?_.injectSketch(b):qb=[]})}function b(a){replayProgressBefore=tb||0,tb=Math.max(0,Math.min(a,1));var b=Math.ceil(tb*sb),c=0;g(),qb=[];a:for(var d=0,e=rb.length;e>d;d++){var f=qb[d]=qb[d]||{color:rb[d].color,thickness:rb[d].thickness,perspective:rb[d].perspective,dashed:rb[d].dashed,eraser:rb[d].eraser,points:[]};xb=f.perspective;var h=rb[d].points.concat();if(c+h.length<b)c+=h.length,f.points=h;else for(var i=0,j=h.length;j>i;i++){var k=h[i];if(f.points.push(k),c++>b)break a}}1===tb&&(xb=yb)}function c(){wb=!0,$("html").addClass("replaying"),clearInterval(ub),ub=setInterval(function(){var a=lb;sb>3e4?a*=2:sb>15e3&&(a*=1.5);var c=Math.ceil(tb*sb)+a;b(c/sb)},kb)}function d(){clearInterval(ub)}function e(){c()}function f(){$("html").removeClass("replaying"),clearInterval(ub),wb&&(wb=!1,tb=1,qb=rb,Db=yb,xb=yb,r())}function g(){Mb.replayControlsProgress.css("width",100*tb+"%")}function h(){if(!navigator.userAgent.match(/ipod|ipad|iphone|android/gi)){var a=!1;try{a="localStorage"in window&&null!==window.localStorage}catch(b){a=!1}}}function i(){colorDropdown=new sketch.Dropdown.create($(".color-dropdown")),colorDropdown.setValue(Bb),colorDropdown.onChanged=function(a){j(a),_.trackEvent("Toolbar","Color",a)},sizeDropdown=new sketch.Dropdown.create($(".size-dropdown")),sizeDropdown.setValue(Cb),sizeDropdown.onChanged=function(a){_.trackEvent("Toolbar","Size",a)},vibrationDropdown=new sketch.Dropdown.create($(".vibration-dropdown")),vibrationDropdown.setValue(1),vibrationDropdown.onChanged=function(a){zb=db*a,_.trackEvent("Toolbar","Vibration",a)}}function j(a){var b=$(".color-dropdown .dropdown-title"),c=sketch.Util.hexToRGB(a),d="rgb("+Math.round(.8*c.r)+","+Math.round(.8*c.g)+","+Math.round(.8*c.b)+")";b.toggleClass("light",c.r+c.g>500||c.r+c.b>500||c.b+c.g>500),b.css({"background-color":a,"box-shadow":"1px 1px 0 "+d+", 2px 2px 0 "+d+", 3px 3px 0 "+d})}function k(){Gb=Y.offset(),Gb.left-=$(window).scrollLeft(),Gb.top-=$(window).scrollTop()}function l(a){m();var b=$('<div class="stencil" style="background-image: url('+a+')">').appendTo(Z),c=$('<div class="stencil-controls">').text("Background image: ").appendTo(Z),d=$('<a class="stencil-button toggle" href="#">'+sketch.Locale.string("hide")+"</a>").appendTo(c),e=$('<a class="stencil-button clear" href="#">'+sketch.Locale.string("remove")+"</a>").appendTo(c);setTimeout(function(){b.addClass("visible")},200),d.on("click",function(a){a.preventDefault(),b.toggleClass("visible"),d.text(sketch.Locale.string(b.hasClass("visible")?"hide":"show"))}),e.on("click",function(a){a.preventDefault(),m()}),$("html").addClass("has-stencil")}function m(){Z.find(".stencil, .stencil-controls").remove(),$("html").removeClass("has-stencil")}function n(a){Hb.press.x=Hb.x,Hb.press.y=Hb.y,a.target==W&&(wb&&f(),Cb=sizeDropdown.getValue()||fb,Bb=colorDropdown.getValue()||gb,qb.push({color:Bb,thickness:Cb,perspective:Db,dashed:Jb,eraser:Kb,points:[]}),a.preventDefault(),Lb===!1&&(Lb=!0,sketch.Main.trackEvent("Canvas","Drew First Line")))}function o(a,b,c,d,e){for(var f=Math.round(Math.random()*c);f--;)pb.push({position:{x:a,y:b},velocity:{x:.5*Math.random()-.25,y:3*Math.random()},alpha:.98,perspective:d,color:e||"#000000"})}function p(){Mb.eraserToggle.toggleClass("on"),Kb=Mb.eraserToggle.hasClass("on")}function q(){requestAnimFrame(q),r()}function r(){X.clearRect(0,0,W.width,W.height),X.save(),X.scale(nb.scale,nb.scale),s(),t(),X.restore()}function s(){var a=999,b=qb[qb.length-1];if(b){var c=b.points[b.points.length-1];c&&(a=sketch.Util.distanceBetween(Hb,c.position))}wb&&(Db+=.08*(xb-Db)),Db=sketch.Util.wrapNumber(Db+Eb,1),Eb*=.8,(Ib.spaceDown||Ib.leftDown||Ib.rightDown)&&(Fb=1),Hb.down&&Ib.spaceDown?Eb+=Hb.diff.x/nb.width:Ib.leftDown&&!Ib.rightDown?Eb-=.005:Ib.rightDown&&!Ib.leftDown?Eb+=.005:Hb.down&&Math.abs(a)>jb&&(b.points.push({position:{x:Hb.x,y:Hb.y},normal:{x:Hb.x,y:Hb.y}}),vb++,Kb||o(Hb.x,Hb.y,5,Db,Bb)),Hb.diff.x=0,Hb.diff.y=0}function t(){for(var a=qb.length,b=0;a>b;b++){var c=qb[b],d=c.color||"#000000",e=c.thickness,f=sketch.Util.wrapNumber(2*(Db-c.perspective),2),g=c.dashed,h=c.eraser,i=c.points,j=i.length,k=i[0],l=i[1];if(h&&(X.save(),X.globalCompositeOperation="destination-out"),j>1){g||X.beginPath();for(var m=-9999,n=-9999,o=-9999,p=-9999,q=1,r=i.length;r>q;q++){g&&X.beginPath(),sketch.Util.distanceBetween(k.position,k.normal)<1&&(k.position.x+=(Math.random()-.5)*zb,k.position.y+=(Math.random()-.5)*zb),k.position.x+=(k.normal.x-k.position.x)*Ab,k.position.y+=(k.normal.y-k.position.y)*Ab;var s=k.position.x,t=l.position.x;s+=f*(k.position.x-.5*bb)*(0>f?1:-1),t+=f*(l.position.x-.5*bb)*(0>f?1:-1);var w=s,x=k.position.y,y=s+(t-s)/2,z=k.position.y+(l.position.y-k.position.y)/2;(1==q||g)&&X.moveTo(w,x),Math.abs(y-o)<2&&Math.abs(z-p)<2||Math.abs(y-m)<2&&Math.abs(z-n)<2||Math.abs(w-o)<2&&Math.abs(x-p)<2||Math.abs(w-m)<2&&Math.abs(x-n)<2?X.lineTo(y,z):X.quadraticCurveTo(w,x,y,z),m=w,n=x,o=y,p=z,k=i[q],l=i[q+1],g&&u(e,d)}g||(u(e,d),X.closePath())}else 1===j&&(k.position.x+=(Math.random()-.5)*zb,k.position.y+=(Math.random()-.5)*zb,k.position.x+=(k.normal.x-k.position.x)*Ab,k.position.y+=(k.normal.y-k.position.y)*Ab,v(k.position.x+f*(k.position.x-.5*bb)*(0>f?1:-1),k.position.y,e/2,d));h&&X.restore()}for(var q=0;q<pb.length;q++){var A=pb[q],f=sketch.Util.wrapNumber(2*(Db-A.perspective),2);A.position.x+=A.velocity.x,A.position.y+=A.velocity.y;var B=A.position.x;B+=f*(A.position.x-.5*nb.width)*(0>f?1:-1),A.alpha*=.94;var C={r:0,g:0,b:0};A.color&&(C=sketch.Util.hexToRGB(A.color)),X.fillStyle="rgba("+C.r+","+C.g+","+C.b+","+A.alpha+")",X.fillRect(B,A.position.y,1,1),A.alpha<.05&&(pb.splice(q,1),q--)}if(Fb>0){X.save(),X.globalAlpha=Math.max(Fb,0),X.beginPath(),X.scale(1,.5);for(var D=Db*Math.PI-Math.PI/2,q=0;2>q;q++){var E=0==q?ib:0;X.moveTo(bb/2,1.7*cb+2),X.arc(bb/2,1.7*cb+E,hb,D-.2,D+.2,!0),X.closePath(),X.lineWidth=4,X.strokeStyle="rgb(165,106,70)",X.stroke(),X.fillStyle="rgba(240,150,105,0.85)",X.fill(),X.beginPath()}X.restore(),Fb-=.05}if(Hb.over){var C=sketch.Util.hexToRGB(Kb?"#000000":colorDropdown.getValue()||gb);X.beginPath(),X.arc(Hb.x,Hb.y,(sizeDropdown.getValue()||fb)/2,0,2*Math.PI,!0),X.closePath(),X.fillStyle="rgba("+C.r+","+C.g+","+C.b+",0.4)",X.fill()}}function u(a,b){X.lineCap="round",X.lineJoin="round",X.lineWidth=a,X.strokeStyle=b,X.stroke()}function v(a,b,c,d){X.beginPath(),X.arc(a,b,c,0,2*Math.PI,!0),X.fillStyle=d,X.fill(),X.closePath()}function w(a){a.preventDefault(),_.saveSketch(),_.trackEvent("Toolbar","Save/Share")}function x(a){a.preventDefault(),wb&&f(),qb.length?_.saveSketch():sketch.ShareOverlay.show(),_.trackEvent("Toolbar","Share")}function y(a){a.preventDefault(),wb&&f(),qb.pop(),_.trackEvent("Toolbar","Undo")}function z(a){if(!sketch.IO.hasUnsavedChanges()||confirm(sketch.Locale.string("alert-unsaved-confirmation"))){{qb.length>0}sb=0,tb=0,rb=[],qb=[],pb=[],sketch.URL.writeID(""),vb=0,_.trackEvent("Toolbar","Reset")}a.preventDefault()}function A(a){if(!sketch.IO.hasUnsavedChanges()||confirm(sketch.Locale.string("alert-unsaved-confirmation"))){var b=qb.length>0;sb=0,tb=0,rb=[],qb=[],pb=[],sketch.URL.writeID(""),vb=0,_.trackEvent("Toolbar","New"),b&&(window.location="/")}a.preventDefault()}function B(a){Mb.dashToggle.toggleClass("on"),Jb=Mb.dashToggle.hasClass("on"),_.trackEvent("Toolbar","Dash",Jb?1:0),a.preventDefault()}function C(a){p(),_.trackEvent("Toolbar","Eraser",Kb?1:0),a.preventDefault()}function D(a){a.preventDefault(),sketch.Social.tweet(sketch.Main.getSketchShareURL(),sketch.Locale.string("sketch-tweet"),"sketchtoy"),sketch.Main.trackEvent("Toolbar","Tweet")}function E(a){var b=!0;switch(a.keyCode){case 32:Ib.spaceDown=!0;break;case 37:Ib.leftDown=!0;break;case 39:Ib.rightDown=!0;break;case 69:p();break;case 90:(a.ctrlKey||a.metaKey)&&qb.pop();break;default:b=!1}b&&(a.preventDefault(),wb&&f())}function F(a){switch(a.keyCode){case 32:Ib.spaceDown=!1,a.preventDefault();break;case 37:Ib.leftDown=!1,a.preventDefault();break;case 39:Ib.rightDown=!1,a.preventDefault()}}function G(a){Hb.down=!0,k(),Hb.x=(a.clientX-Gb.left)/nb.scale,Hb.y=(a.clientY-Gb.top)/nb.scale,n(a)}function H(a){Hb.over&&k(),Hb.prev.x=Hb.x,Hb.prev.y=Hb.y,Hb.x=(a.clientX-Gb.left)/nb.scale,Hb.y=(a.clientY-Gb.top)/nb.scale,Hb.diff.x=Hb.x-Hb.prev.x,Hb.diff.y=Hb.y-Hb.prev.y}function I(a){Hb.down=!1,Hb.x=(a.clientX-Gb.left)/nb.scale,Hb.y=(a.clientY-Gb.top)/nb.scale}function J(){k(),Hb.over=!0}function K(){Hb.over=!1}function L(a){1==a.touches.length&&"CANVAS"===a.target.nodeName&&(Hb.down=!0,Gb=Y.offset(),Gb.left+=10,Gb.top-=$(window).scrollTop()-10,Hb.x=(a.touches[0].pageX-Gb.left)/nb.scale,Hb.y=(a.touches[0].pageY-Gb.top)/nb.scale,n(a),a.preventDefault())}function M(a){1==a.touches.length&&(a.preventDefault(),Hb.prev.x=Hb.x,Hb.prev.y=Hb.y,Hb.x=(a.touches[0].pageX-Gb.left)/nb.scale,Hb.y=(a.touches[0].pageY-Gb.top)/nb.scale,Hb.diff.x=Hb.x-Hb.prev.x,Hb.diff.y=Hb.y-Hb.prev.y)}function N(){Hb.down=!1}function O(a){if(a||(a=window.event),vb>4){var b=sketch.Locale.string("alert-unsaved-statement");return a.cancelBubble=!0,a.returnValue=b,a.stopPropagation&&(a.stopPropagation(),a.preventDefault()),b}}function P(){setTimeout(function(){sketch.Social.initialize()},500),setTimeout(function(){sketch.Related.initialize()},500)}function Q(){var a=1250;$("html").hasClass("wide-scyscraper")&&(a=1330);var b=mb&&(sketch.Util.isTouchDevice()||window.innerWidth<a);$("html").toggleClass("scyscrapes-below",b),ob.width=Math.max(window.innerWidth,ab),ob.height=window.innerHeight,nb.scale=1,nb.width=bb*nb.scale,nb.height=cb*nb.scale,W.width=nb.width,W.height=nb.height,Z.width(nb.width).height(nb.height),nb.x=Y.position().left,nb.y=Y.position().top,Mb.spinner.css({top:nb.y+(nb.height/2-16)}),Mb.toolbar.width(nb.width),$(".sketch-canvas-wrapper").css("width",b?nb.width:"initial"),$(".sketch-footer").css({left:nb.x,width:nb.width})}function R(a){a.preventDefault();var b=a.dataTransfer.files;if(b.length){var c=new FileReader;c.onloadend=S,c.readAsDataURL(b[0])}}function S(a){a.target.result.match(/^data:image/gi)?l(a.target.result):alert("Doesn't seem like that's an image. Please try another file.")}function T(a){d(),$(document).on("mousemove",U).on("mouseup",V),U(a)}function U(a){var c=(a.clientX-Mb.replayControls.offset().left)/Mb.replayControls.width();b(c),a.preventDefault()}function V(){e(),$(document).off("mousemove",U).off("mouseup",V)}var W,X,Y,Z,_={},ab=760,bb=960,cb=580,db=3,eb=.7,fb=3,gb="#000000",hb=50,ib=6,jb=4,kb=20,lb=2,mb=!(!$("#left-pillar").length||!$("#right-pillar").length),nb={x:0,y:0,scale:1,width:bb,height:cb},ob={width:0,height:0},pb=[],qb=[],rb=[],sb=0,tb=0,ub=0,vb=0,wb=!1,xb=0,yb=0,zb=db,Ab=eb,Bb=gb,Cb=fb,Db=0,Eb=0,Fb=0,Gb={x:0,y:0},Hb={x:0,y:0,prev:{x:0,y:0},diff:{x:0,y:0},press:{x:0,y:0},down:!1,over:!1},Ib={spaceDown:!1,leftDown:!1,rightDown:!1},Jb=!1,Kb=!1,Lb=!1,Mb={toolbar:null,saveButton:null,resetButton:null,dashToggle:null,vibrationDropdown:null,sizeDropdown:null,facebookConnect:null};return _.initialize=function(){if(Z=$(".sketch-canvas-container"),Y=$(".sketch-canvas"),W=Y.get(0),Mb.spinner=$("#spinner"),Mb.toolbar=$(".toolbar"),Mb.saveButton=$(".toolbar .save-button"),Mb.undoButton=$(".toolbar .undo-button"),Mb.newButton=$(".toolbar .new-button"),Mb.resetButton=$(".toolbar .reset-button"),Mb.dashToggle=$(".toolbar .dash-toggle"),Mb.eraserToggle=$(".toolbar .eraser-toggle"),Mb.shareButton=$(".toolbar .share-button"),Mb.tweetButton=$(".toolbar .tweet-button"),Mb.replayControls=$(".replay-controls"),Mb.replayControlsProgress=$(".replay-controls .progress"),i(),h(),sketch.IO.initialize(),sketch.Locale.initialize(),W&&W.getContext){X=W.getContext("2d"),W.addEventListener("mousedown",G,!1),document.addEventListener("mousemove",H,!1),document.addEventListener("mouseup",I,!1),W.addEventListener("touchstart",L,!1),W.addEventListener("touchmove",M,!1),document.addEventListener("touchend",N,!1),document.addEventListener("keydown",E,!1),document.addEventListener("keyup",F,!1),document.addEventListener("dragover",function(a){a.preventDefault()
},!1),document.addEventListener("dragenter",function(a){a.preventDefault()},!1),document.addEventListener("dragexit",function(a){a.preventDefault()},!1),document.addEventListener("drop",R,!1),Mb.replayControls.on("mousedown",T),Mb.saveButton.on("click touchstart",w),Mb.shareButton.on("click touchstart",x),Mb.undoButton.on("click touchstart",y),Mb.newButton.on("click touchstart",A),Mb.resetButton.on("click touchstart",z),Mb.dashToggle.on("click touchstart",B),Mb.eraserToggle.on("click touchstart",C),Mb.tweetButton.on("click touchstart",D),window.addEventListener("resize",Q,!1),window.addEventListener("beforeunload",O,!1),$(window).on("load",P),Q(),Mb.toolbar.css("visibility","visible"),sketch.Util.isTouchDevice()?$("html").addClass("touch"):(Y.on("mouseover",J),Y.on("mouseout",K)),"undefined"!=typeof chrome&&chrome.app&&chrome.app.isInstalled?$("html").addClass("chrome-app-installed"):navigator.userAgent.match(/chrome/gi)&&$("html").addClass("chrome-app-capable"),$("html").addClass("initialized"),q();var b=sketch.URL.readID();b.length>=1&&a(b)}},_.trackEvent=function(a,b,c,d,e){_gaq.push(["_trackEvent",a,b,c,d,e])},_.displayError=function(a){alert(a)},_.getSketchShareURL=function(){return window.location.protocol+"//"+window.location.host+"/"+sketch.URL.readID()},_.isEmpty=function(){return 0===qb.length},_.linesToJSON=function(){for(var a=0;a<qb.length;a++)qb[a]&&qb[a].points&&0!=qb[a].points.length||(qb.splice(a,1),a--);var b="{";b+='"p":'+Db.toFixed(6)+",",b+='"a":'+zb.toFixed(6)+",",b+='"l":[';for(var a=0;a<qb.length;a++){var c=qb[a].points;b+="{",b+='"t":'+qb[a].thickness+",",b+='"p":'+(0==qb[a].perspective?"0.000100":qb[a].perspective.toFixed(6))+",",b+='"d":'+(qb[a].dashed?1:0)+",",b+='"e":'+(qb[a].eraser?1:0)+",",qb[a].color&&"#000000"!==qb[a].color&&(b+='"c":"'+qb[a].color+'",'),b+='"points":[';for(var d=0;d<c.length;d++){var e=c[d],f=Math.round(e.normal.x),g=Math.round(e.normal.y);b+='"'+f+"x"+g+'"',b+=d<c.length-1?",":""}b+="]}",b+=a<qb.length-1?",":""}return b+="]}"},_.saveSketch=function(){qb.length>0?(f(),sketch.IO.saveSketch(),vb=0):alert("You need to draw something to save.")},_.exportSketch=function(){Fb=0,f(),sketch.ShareOverlay.show(),W.style.display="none"},_.getSketchAsImage=function(){return X.save(),X.globalCompositeOperation="destination-over",X.fillStyle="#fff",X.fillRect(0,0,nb.width,nb.height),X.restore(),W.toDataURL("image/png")},_.saveSketchAsImage=function(){var a=window.open("about:blank","Your Sketch");a.document.write("<img src='"+_.getSketchAsImage()+"' />")},_.getSketchAsBlob=function(){var a=W.toDataURL("image/png");if(!a||!window.Blob||!window.atob)return null;var b,c=window.atob(a.split(",")[1]),d=a.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(c.length),f=new Uint8Array(e);for(b=c.length;b--;)f[b]=c.charCodeAt(b);try{if(window.DataView)return new Blob([new DataView(e)],{type:d})}catch(g){}try{return new Blob([f],{type:d})}catch(g){}return null},_.injectSketch=function(a){a.perspective&&(Db=a.perspective,yb=a.perspective),a.amplitude&&(zb=a.amplitude,vibrationDropdown.setValue(Math.round(a.amplitude/db))),rb=a.lines,tb=0,sb=0;for(var b=0;b<rb.length;b++){var d=rb[b].points;d&&(sb+=d.length)}c()},_}(),sketch.Main.initialize();